<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!--Converted with LaTeX2HTML 98.2 beta5 (July 28th, 1998)
original version by:  Nikos Drakos, CBLU, University of Leeds
* revised and updated by:  Marcus Hennecke, Ross Moore, Herb Swan
* with significant contributions from:
  Jens Lippmann, Marek Rouchal, Martin Wilck and others -->
<HTML>
<HEAD>
<TITLE>Control flow</TITLE>
<META NAME="description" CONTENT="Control flow">
<META NAME="keywords" CONTENT="embroot">
<META NAME="resource-type" CONTENT="document">
<META NAME="distribution" CONTENT="global">
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=iso-8859-1">
<LINK REL="STYLESHEET" HREF="embroot.css">
<LINK REL="previous" HREF="node4.html">
<LINK REL="up" HREF="node2.html">
<LINK REL="next" HREF="node6.html">
</HEAD>
<BODY >
<!--Navigation Panel-->
<A NAME="tex2html729"
 HREF="node6.html">
<IMG WIDTH="37" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="next" SRC="next_motif.gif"></A> 
<A NAME="tex2html725"
 HREF="node2.html">
<IMG WIDTH="26" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="up" SRC="up_motif.gif"></A> 
<A NAME="tex2html721"
 HREF="node4.html">
<IMG WIDTH="63" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="previous" SRC="previous_motif.gif"></A>  
<A NAME="tex2html727"
 HREF="node76.html">
<IMG WIDTH="43" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="index" SRC="index_motif.gif"></A> 
<BR>
<B> Next:</B> <A NAME="tex2html730"
 HREF="node6.html">Managing Data and Memory</A>
<B> Up:</B> <A NAME="tex2html726"
 HREF="node2.html">Calling ECLiPSe from C++</A>
<B> Previous:</B> <A NAME="tex2html722"
 HREF="node4.html">Creating an ECLiPSe context</A>
 &nbsp <B>  <A NAME="tex2html728"
 HREF="node76.html">Index</A></B> 
<BR>
<BR>
<!--End of Navigation Panel-->
<!--Table of Child-Links-->
<A NAME="CHILD_LINKS"><STRONG>Subsections</STRONG></A>

<UL>
<LI><A NAME="tex2html731"
 HREF="node5.html#SECTION00231000000000000000">Control flow and search</A>
<LI><A NAME="tex2html732"
 HREF="node5.html#SECTION00232000000000000000">Asynchronous events</A>
<LI><A NAME="tex2html733"
 HREF="node5.html#SECTION00233000000000000000">The yield-resume model</A>
<LI><A NAME="tex2html734"
 HREF="node5.html#SECTION00234000000000000000">Summary of EC_resume() arguments</A>
</UL>
<!--End of Table of Child-Links-->
<HR>

<H1><A NAME="SECTION00230000000000000000">
Control flow</A>
</H1>

<P>
ECLiPSe and a C or C++ main program are like threads running in a
single process. Each maintains its state and methods for exchanging
<A NAME="363"></A>
<A NAME="364"></A>
data and yielding control to the other thread.

<P>
The main method of sending data from C++ to ECLiPSe is by posting
<A NAME="366"></A>
goals for it to solve. All posted goals are solved in conjunction
with each other, and with any previously posted goals that have
succeeded.

<P>
Data is passed back by binding logical variables within the goals.
<A NAME="367"></A>

<P>
<A NAME="368"></A>
Control is explicit in C++. After posting some goals, the C++ program
calls the <code>EC_resume()</code> function and these goals are all
solved. A return code says whether they were successfully solved
or whether a failure occurred.

<P>
In ECLiPSe control is normally implicit. Control returns to C++ when all
goals have been solved.

<P>
<PRE>
    #include        "eclipseclass.h"

    main()
    {
        ec_init();

        /* writeln("hello world"), */
        post_goal(term(EC_functor("writeln",1),"hello world"));
        EC_resume();
        ec_cleanup(0);
    }
</PRE>
The above is an example program that posts a goal and executes it.

<P>

<H2><A NAME="SECTION00231000000000000000">
Control flow and search</A>
</H2>

<P>
Using this model of communication it is possible to construct programs where
execution of C++ code and search within the ECLiPSe are interleaved.

<P>
<A NAME="374"></A>
<A NAME="375"></A>
<A NAME="376"></A>
If you post a number of goals (of which some are non-deterministic) and
resume the ECLiPSe execution and the goals succeed, then control returns
to the C++ level. By posting a goal that fails, the ECLiPSe execution
will fail back into the previous set of goals and these will succeed with
a different solution. 

<P>
<PRE>
    #include        "eclipseclass.h"

    main()
    {
        ec_init();
        EC_ref Pred;

        post_goal(term(EC_functor("current_built_in",1),Pred));
        while (EC_succeed == EC_resume())
        {
            post_goal(term(EC_functor("writeln",1),Pred));
            post_goal(EC_atom("fail"));
        }
        ec_cleanup(0);
    }
</PRE>
The above example prints all the built ins available in ECLiPSe.
When <code>EC_resume()</code> returns <code>EC_succeed</code> there is a solution
to a set of posted goals, and we print out the value of <code>Pred</code>.
otherwise <code>EC_resume()</code> returns <code>EC_fail</code> to indicate
that no more solutions to any set of posted goals is available.

<P>
<A NAME="382"></A>
It is possible also to cut such search. So for example one could modify
the example above to only print the 10th answer. Initially one simply
fails, but at the tenth solution one cuts further choices. Then
one prints the value of 'Pred'.

<P>
<PRE>
    #include        "eclipseclass.h"

    main()
    {
        ec_init();
        EC_ref Pred,Choice;
        int i = 0;

        post_goal(term(EC_functor("current_built_in",1),Pred));
        while (EC_succeed == EC_resume(Choice))
        {
            if (i++ == 10)
            {
                Choice.cut_to();
                break;
            }
            post_goal(term(EC_atom("fail")));
        }
        post_goal(term(EC_functor("writeln",1),Pred));
        EC_resume():
        ec_cleanup(0);
    }
</PRE>

<P>
<A NAME="385"></A>
When <code>EC_resume()</code> is called with an <code>EC_ref</code> argument, this
is for data returned by the <code>EC_resume()</code> If the return code is
<code>EC_succeed</code> The <code>EC_ref</code> is set to a choicepoint identifier
which can be used for cutting further choices at that point.

<P>

<H2><A NAME="SECTION00232000000000000000">
Asynchronous events</A>
</H2>

<P>
<A NAME="387"></A>
<A NAME="388"></A>
The posting of goals and building of any ECLiPSe terms in general
cannot be done asynchronously to the ECLiPSe execution. It has to
be done after the <code>EC_resume()</code> function has returned.

<P>
<A NAME="391"></A>
Sometimes it may be necessary to signal some asynchronous event to
ECLiPSe, for example to implement a time-out. To do this one
posts a named event to ECLiPSe. At the next synchronous point
within the eclipse execution, the handler for that event is
invoked.
<PRE>
    /* C++ code, possibly within a signal handler */
    post_event(EC_atom("timeout"));

    /* ECLiPSe code */
    handle_timeout(timeout) :-
        &lt;appropriate action&gt;

    :- set_event_handler(timeout, handle_timeout/1).
</PRE>

<P>

<H2><A NAME="SECTION00233000000000000000">
The yield-resume model</A>
</H2>

<P>
<A NAME="397"></A>
<A NAME="398"></A>
<A NAME="399"></A>
Although implicitly yielding control when a set of goals succeeds
or fails is often enough, it is possible to explicitly yield
control to the C++ level. This is done with the
<A NAME="tex2html28"
 HREF="../bips/kernel/externals/yield-2.html">yield/2</A><A NAME="568"></A>
predicate.  This yields control to the calling C++ program.
The arguments are used for passing data to C++ and from C++.

<P>
When <A NAME="tex2html30"
 HREF="../bips/kernel/externals/yield-2.html">yield/2</A><A NAME="571"></A> is called within ECLiPSe code, the <code>EC_resume()</code>
function returns the value <code>EC_yield</code> so one can recognise this case.
The data passed out via the first argument of <A NAME="tex2html32"
 HREF="../bips/kernel/externals/yield-2.html">yield/2</A><A NAME="574"></A>
can  be accessed from C++ via the <code>EC_ref</code> argument to <code>EC_resume()</code>.
The data received in the second argument of <A NAME="tex2html34"
 HREF="../bips/kernel/externals/yield-2.html">yield/2</A><A NAME="577"></A> is either
the list of posted goals, or an <code>EC_word</code> passed as an input
argument to <code>EC_resume()</code>.

<P>
<PRE>
    yield(out(1,2),InData),
</PRE>

<P>
In this example the compound term <code>out(1,2)</code> is passed to C++.
If we had previously called:
<PRE>
    EC_ref FromEclipse;
    result = EC_resume(FromEclipse);
</PRE>
then <code>result</code> would be <code>EC_yield</code> and <code>FromEclipse</code> would
refer to <code>out(1,2)</code>. If then we resumed execution with:
<PRE>
    result = EC_resume(EC_atom("ok"),FromEclipse);
</PRE>
then the variable <code>InData</code> on the ECLiPSe side
would be set to the atom 'ok'.

<P>

<H2><A NAME="SECTION00234000000000000000">
Summary of EC_resume() arguments</A>
</H2>

<P>
<A NAME="417"></A>
<code>EC_resume()</code> can be called with two optional arguments. An
input argument that is an <code>EC_word</code> and an output that is an
<code>EC_ref</code>.

<P>
If the input argument is omitted, input is taken as the list of posted
goals. Otherwise the input to ECLiPSe is exactly that argument.

<P>
If the output argument is present, its content depends on the value
returned by <code>EC_resume()</code>. If it returns <code>EC_succeed</code> it is
<A NAME="419"></A>
the choicepoint identifier. If it returns <code>EC_yield</code> It is the
first argument to the  <A NAME="tex2html38"
 HREF="../bips/kernel/externals/yield-2.html">yield/2</A><A NAME="580"></A> goal. If it returns <code>EC_fail</code>
it is not modified.

<P>
<HR>
<!--Navigation Panel-->
<A NAME="tex2html729"
 HREF="node6.html">
<IMG WIDTH="37" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="next" SRC="next_motif.gif"></A> 
<A NAME="tex2html725"
 HREF="node2.html">
<IMG WIDTH="26" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="up" SRC="up_motif.gif"></A> 
<A NAME="tex2html721"
 HREF="node4.html">
<IMG WIDTH="63" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="previous" SRC="previous_motif.gif"></A>  
<A NAME="tex2html727"
 HREF="node76.html">
<IMG WIDTH="43" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="index" SRC="index_motif.gif"></A> 
<BR>
<B> Next:</B> <A NAME="tex2html730"
 HREF="node6.html">Managing Data and Memory</A>
<B> Up:</B> <A NAME="tex2html726"
 HREF="node2.html">Calling ECLiPSe from C++</A>
<B> Previous:</B> <A NAME="tex2html722"
 HREF="node4.html">Creating an ECLiPSe context</A>
 &nbsp <B>  <A NAME="tex2html728"
 HREF="node76.html">Index</A></B> 
<!--End of Navigation Panel-->
<ADDRESS>
<I>Warwick Harvey</I>
<BR><I>2005-01-25</I>
</ADDRESS>
</BODY>
</HTML>
