<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!--Converted with LaTeX2HTML 98.2 beta5 (July 28th, 1998)
original version by:  Nikos Drakos, CBLU, University of Leeds
* revised and updated by:  Marcus Hennecke, Ross Moore, Herb Swan
* with significant contributions from:
  Jens Lippmann, Marek Rouchal, Martin Wilck and others -->
<HTML>
<HEAD>
<TITLE>Example</TITLE>
<META NAME="description" CONTENT="Example">
<META NAME="keywords" CONTENT="embroot">
<META NAME="resource-type" CONTENT="document">
<META NAME="distribution" CONTENT="global">
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=iso-8859-1">
<LINK REL="STYLESHEET" HREF="embroot.css">
<LINK REL="previous" HREF="node37.html">
<LINK REL="up" HREF="node34.html">
<LINK REL="next" HREF="node39.html">
</HEAD>
<BODY >
<!--Navigation Panel-->
<A NAME="tex2html1225"
 HREF="node39.html">
<IMG WIDTH="37" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="next" SRC="next_motif.gif"></A> 
<A NAME="tex2html1221"
 HREF="node34.html">
<IMG WIDTH="26" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="up" SRC="up_motif.gif"></A> 
<A NAME="tex2html1217"
 HREF="node37.html">
<IMG WIDTH="63" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="previous" SRC="previous_motif.gif"></A>  
<A NAME="tex2html1223"
 HREF="node76.html">
<IMG WIDTH="43" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="index" SRC="index_motif.gif"></A> 
<BR>
<B> Next:</B> <A NAME="tex2html1226"
 HREF="node39.html">Using the Java-ECLiPSe Interface</A>
<B> Up:</B> <A NAME="tex2html1222"
 HREF="node34.html">Tcl Peer Multitasking Interface</A>
<B> Previous:</B> <A NAME="tex2html1218"
 HREF="node37.html">Overview</A>
 &nbsp <B>  <A NAME="tex2html1224"
 HREF="node76.html">Index</A></B> 
<BR>
<BR>
<!--End of Navigation Panel-->

<H1><A NAME="SECTION00740000000000000000">
Example</A>
</H1>

<P>
Here we present a simple example use of the Tcl peer multitasking
facilities. The full programs (Tcl and ECLiPSe code) are available in
the ECLiPSe distribution as <TT>example_multi.ecl</TT> and <TT>  example_multi.tcl</TT>.

<P>
The Tcl program uses the remote Tcl peer interface to create a window that
interacts with the ECLiPSe process it is attached to. Multiple copies of
the program can be run, and attached to the same ECLiPSe process with a
different remote peer. Each window has three buttons:

<UL><LI>run: a button to send an ERPC goal to ECLiPSe (in this case a simple
  writeln with the peer name;

<LI>end: a button to end interaction with ECLiPSe and return control
  to ECLiPSe;

<LI>reg: a button to toggle the registration/deregistration of the peer
  for peer multitasking;

</UL>

<P>
The program interacts with ECLiPSe when the run button is pressed. This
can be done either during a peer multitasking phase, or when the program's specific
peer is given control on its own. When the peer is given control on its
own, only it can interact with ECLiPSe; while during peer multitasking,
all the multitasking peers (the copies of the program that are running) can
interact with ECLiPSe, i.e. the run buttons in all the windows can all
be pressed. 

<P>
After attaching to ECLiPSe with <B>ec_remote_init</B>, the program sets
various handlers for the handing of control between ECLiPSe and itself
with <B>ec_running_set_commands</B>: 

<P>
<PRE>
ec_running_set_commands ec_start ec_end {} disable_buttons
</PRE>

<P>
The handlers for when control is handed back to ECLiPSe, <TT>ec_start</TT>,
and when control is handed over from ECLiPSe, <TT>ec_end</TT>, are defined
thus: 

<P>
<PRE>
proc ec_end {} {
    if {[ec_multi:get_multi_status] != "on"} {
        enable_buttons
    }
}

proc ec_start {} {
    if {[ec_multi:get_multi_status] != "on"} {
        disable_buttons
    }
}
</PRE>

<P>
<TT>enable_buttons</TT> and <TT>disable_buttons</TT> enables and disables the
buttons for the window, respectively. The code tests if the peer is
multitasking with <TT>ec_multi:get_multi_status</TT>. This is needed because
during a peer multitasking phase, control is repeatedly handed back and
forth, and we don't want the buttons to be repeatedly enabled and disabled
during this phase.

<P>
Next, the program registers the peer for peer multitasking:

<P>
<PRE>
    ec_multi:peer_register [list start multi_start_handler \
                            interact multi_interact_handler]
</PRE>

<P>
No special handler is
needed for the end of multitasking, as no special action is needed beyond
disabling the buttons. The return code is stored in a global variable <TT>  return_code</TT>. The start handler is defined thus:

<P>
<PRE>
proc multi_start_handler {type} {
    global return_code

    if {$type == "demo"} {
        set return_code continue
        enable_buttons
    } else {
        set return_code no
    }
    return $return_code
}
</PRE>

<P>
As discussed, multitasking phases can be of different types. For
demonstrating this multitasking features of this example program, the type
is ``demo''. Therefore the handler tests for this and enables the button if
the phase is ``demo''. On the ECLiPSe side, the multitasking phase is
started with the following predicate call:

<P>
<PRE>
        peer_do_multitask(demo),
</PRE>

<P>
The interact handler is defined thus:

<P>
<PRE>
proc multi_interact_handler {type} {
    global return_code

    if {$return_code == "terminate"} {
            disable_buttons
    }
    return $return_code
</PRE>

<P>
The code checks for the two cases where the user has requested to terminate
the multitasking phase by pressing the <TT>.end</TT> button, and disables the
buttons. The end button itself invokes the following code to set <TT>  return_code</TT>: 

<P>
<PRE>
proc end_interaction {} {
    global return_code
    set return_code terminate
    if {[ec_multi:get_multi_status] != "on"} {
        ec_resume
    }
}
</PRE>

<P>
The code checks if it is in a peer multitasking phase, and if so,
<TT>return_code</TT> is set to <TT>terminate</TT>, so that when the handler
returns, the multitasking phase will terminate.
Otherwise, the peer has been explicitly handed control exclusively,
and so control is handed back to ECLiPSe in the normal way using <B>  ec_resume</B>.

<P>
The program also allows a peer to deregister from multitasking or, if
already deregistered, to register again for multitasking. This is handling
by the following two procedures:

<P>
<PRE>
proc register_for_multi {} {
    ec_multi:peer_register [list start multi_start_handler]
    .reg configure  -command {deregister_for_multi}
    .reg configure -text "Deregister multitasking"
}

proc deregister_for_multi {} {
    ec_multi:peer_deregister
    .reg configure  -command {register_for_multi}
    .reg configure -text "Register multitasking"
}
</PRE>

<P>
Pressing the <TT>.reg</TT> button will either call <TT>register_for_multi</TT> or
<TT>deregister_for_multi</TT>, depending on if the peer is currently
deregistered or registered for peer multitasking (respectively). The
procedure also changes the button to toggle to the other state.

<P>
Pressing the button during a peer multitasking phase will remove the peer
from multitasking immediately. If pressed while the peer is given exclusive
control, the peer will not participate in future multitasking phase (unless
it is re-registered). 

<P>

<P>
<HR>
<!--Navigation Panel-->
<A NAME="tex2html1225"
 HREF="node39.html">
<IMG WIDTH="37" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="next" SRC="next_motif.gif"></A> 
<A NAME="tex2html1221"
 HREF="node34.html">
<IMG WIDTH="26" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="up" SRC="up_motif.gif"></A> 
<A NAME="tex2html1217"
 HREF="node37.html">
<IMG WIDTH="63" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="previous" SRC="previous_motif.gif"></A>  
<A NAME="tex2html1223"
 HREF="node76.html">
<IMG WIDTH="43" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="index" SRC="index_motif.gif"></A> 
<BR>
<B> Next:</B> <A NAME="tex2html1226"
 HREF="node39.html">Using the Java-ECLiPSe Interface</A>
<B> Up:</B> <A NAME="tex2html1222"
 HREF="node34.html">Tcl Peer Multitasking Interface</A>
<B> Previous:</B> <A NAME="tex2html1218"
 HREF="node37.html">Overview</A>
 &nbsp <B>  <A NAME="tex2html1224"
 HREF="node76.html">Index</A></B> 
<!--End of Navigation Panel-->
<ADDRESS>
<I>Warwick Harvey</I>
<BR><I>2005-01-25</I>
</ADDRESS>
</BODY>
</HTML>
